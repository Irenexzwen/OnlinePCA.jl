using OnlinePCA
using ArgParse:
    ArgParseSettings, parse_args, @add_arg_table

# main
function main()
    pca = OnlinePCA.RSGD()
    parsed_args = OnlinePCA.parse_commandline(pca)
    println("Parsed args:")
    for (arg,val) in parsed_args
        println("  $arg  =>  $val")
    end

    if parsed_args["logscale"]
        logscale=true
    else
        logscale=parse(Bool, parsed_args["logscale"])
    end

    if parsed_args["pseudocount"] == Float32(1)
        pseudocount = Float32(1)
    else
        pseudocount=Float32(parsed_args["pseudocount"])
    end

    dim=parse(Int64, parsed_args["dim"])

    if parsed_args["stepsize"] == Float32(0.1)
        stepsize = Float32(0.1)
    else
        stepsize=parse(Float32, parsed_args["stepsize"])
    end

    numepoch=parse(Int64, parsed_args["numepoch"])

    if parsed_args["g"] == Float32(0.9)
        g = Float32(0.9)
    else
        g=parse(Float32, parsed_args["g"])
    end

    if parsed_args["epsilon"] == Float32(1.0e-8)
        epsilon = Float32(1.0e-8)
    else
        epsilon=parse(Float32, parsed_args["epsilon"])
    end

    if parsed_args["logdir"] == nothing
        logdir = parsed_args["logdir"]
    else
        logdir = String(parsed_args["logdir"])
    end

    out = OnlinePCA.rsgd(input=parsed_args["input"],
        logscale=logscale,
        pseudocount=pseudocount,
        rowmeanlist=parsed_args["rowmeanlist"],
        colsumlist=parsed_args["colsumlist"],
        masklist=parsed_args["masklist"],
        dim=dim,
        stepsize=stepsize,
        numepoch=numepoch,
        scheduling=parsed_args["scheduling"],
        g=g,
        epsilon=epsilon,
        logdir=logdir)
    OnlinePCA.output(parsed_args["outdir"], out)
end

main()